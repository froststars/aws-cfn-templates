AWSTemplateFormatVersion: '2010-09-09'
Conditions:
  CreateSecurityGroupCondition: !Equals [!Ref 'SecurityGroup', '']
  DefaultKmsCondition: !And [!Equals [!Ref 'StorageEncrypted', 'true'], !Equals [
      !Ref 'KmsKeyId', '']]
  EnhancedMonitoringCondition: !Not [!Equals [!Ref 'EnhancedMonitoringConditionRole',
      '']]
  IopsStorageCondition: !Equals [!Ref 'StorageType', io1]
  NewDatabaseCondition: !Equals [!Ref 'DatabaseSnapshot', '']
  UseSnapshotCondition: !Not [!Equals [!Ref 'DatabaseSnapshot', '']]
Description: PostGres RDS instance.
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
    - Label:
        default: Network Configuration
      Parameters:
      - VpcId
      - SubnetIds
      - SecurityGroup
    - Label:
        default: Database Basic Configuration
      Parameters:
      - DatabaseSnapshot
      - DatabaseClass
      - DatabaseEngineVersion
      - DatabaseMultiAz
      - DatabaseUser
      - DatabasePassword
    - Label:
        default: Database Storage Configuration
      Parameters:
      - StorageSize
      - StorageType
      - StorageIops
      - StorageEncrypted
      - KmeKeyId
    - Label:
        default: Database Security Configuration
      Parameters:
      - EnhancedMonitoringConditionRole
      - ClientLocation
      - PubliclyAccessible
    ParameterLabels:
      ClientLocation:
        default: Client Location
      DatabaseClass:
        default: Database Class
      DatabaseEngineVersion:
        default: Database Engine Version
      DatabaseMultiAz:
        default: Database Multi Az
      DatabasePassword:
        default: Database Password
      DatabaseSnapshot:
        default: Database Snapshot
      DatabaseUser:
        default: Database User
      EnhancedMonitoringConditionRole:
        default: Enhanced Monitoring Condition Role
      KmeKeyId:
        default: Kme Key Id
      PubliclyAccessible:
        default: Publicly Accessible
      SecurityGroup:
        default: Security Group
      StorageEncrypted:
        default: Storage Encrypted
      StorageIops:
        default: Storage Iops
      StorageSize:
        default: Storage Size
      StorageType:
        default: Storage Type
      SubnetIds:
        default: Subnet Ids
      VpcId:
        default: Vpc Id
Outputs:
  EndpointAddress:
    Description: Endpoint address
    Value: !GetAtt 'PostgresRDS.Endpoint.Address'
  EndpointPort:
    Description: Endpoint port
    Value: !GetAtt 'PostgresRDS.Endpoint.Port'
  EnvironmentVariables:
    Description: Database environment variables
    Value: !Sub 'PGHOST=${PostgresRDS.Endpoint.Address} PGPORT=${PostgresRDS.Endpoint.Port}
      PGUSER=${DatabaseUser} PGPASSWORD=${DatabasePassword} '
Parameters:
  ClientLocation:
    AllowedPattern: (\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/(\d{1,2})
    ConstraintDescription: must be a valid CIDR range of the form x.x.x.x/x.
    Default: 0.0.0.0/0
    Description: Lockdown database access (default can be accessed from anywhere)
    MaxLength: '18'
    MinLength: '9'
    Type: String
  DatabaseClass:
    AllowedValues:
    - db.t2.micro
    - db.t2.small
    - db.t2.medium
    - db.t2.large
    - db.m3.medium
    - db.m3.large
    - db.m3.xlarge
    - db.m3.2xlarge
    - db.m4.large
    - db.m4.xlarge
    - db.m4.2xlarge
    - db.m4.4xlarge
    - db.m4.10xlarge
    - db.m4.16xlarge
    - db.r3.large
    - db.r3.xlarge
    - db.r3.2xlarge
    - db.r3.4xlarge
    - db.r3.8xlarge
    Default: db.t2.micro
    Description: Database instance class
    Type: String
  DatabaseEngineVersion:
    AllowedValues:
    - 9.6.3
    - 9.6.2
    - 9.6.1
    - 9.5.7
    - 9.5.6
    - 9.5.4
    - 9.5.2
    - 9.4.12
    - 9.4.11
    - 9.4.9
    - 9.4.7
    - 9.3.17
    - 9.3.16
    - 9.3.14
    - 9.3.12
    Default: 9.5.4
    Description: Database engine version
    Type: String
  DatabaseMultiAz:
    AllowedValues:
    - 'true'
    - 'false'
    Default: 'false'
    Description: Whether use a multi-AZ Deployment
    NoEcho: true
    Type: String
  DatabasePassword:
    AllowedPattern: '[a-zA-Z0-9]*'
    ConstraintDescription: must contain only alphanumeric characters.
    Description: The database admin account password, ignored when a snapshot is specified
    MaxLength: '41'
    MinLength: '1'
    NoEcho: true
    Type: String
  DatabaseSnapshot:
    Default: ''
    Description: ARN of a DB snapshot to restore from
    Type: String
  DatabaseUser:
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'
    ConstraintDescription: must begin with a letter and contain only alphanumeric
      characters.
    Description: The database admin account username, ignored when a snapshot is specified
    MaxLength: '16'
    MinLength: '1'
    NoEcho: true
    Type: String
  EnhancedMonitoringConditionRole:
    AllowedValues:
    - ''
    - rds-monitoring-role
    Default: ''
    Description: Database enhanced monitoring role name, leaf blank to disable enhanced
      monitoring
    Type: String
  KmsKeyId:
    Default: ''
    Description: The ARN of the KMS master key that is used to encrypt the DB instance,
      If you enable the StorageEncrypted property but don't specify this property,
      AWS CloudFormation uses the default master key.
    Type: String
  PubliclyAccessible:
    AllowedValues:
    - 'false'
    - 'true'
    Default: 'false'
    Description: Whether the database endpoint is publicly accessible
    Type: String
  SecurityGroup:
    Default: ''
    Description: Database security group id, a new security group will be created
      this is left empty.
    Type: String
  StorageEncrypted:
    AllowedValues:
    - 'true'
    - 'false'
    Default: 'false'
    Description: Indicates whether the DB instance is encrypted.
    Type: String
  StorageIops:
    ConstraintDescription: IOPS range is 100 to 30000
    Default: '100'
    Description: IOPS database storage supports, used when the volume type is io1
    MaxValue: '30000'
    MinValue: '100'
    Type: Number
  StorageSize:
    ConstraintDescription: must be between 5GB and 6TB.
    Default: '5'
    Description: The size of the database storage in GB
    MaxValue: '6144'
    MinValue: '5'
    Type: Number
  StorageType:
    AllowedValues:
    - gp2
    - io1
    - default
    Default: gp2
    Description: Database storage type
    Type: String
  SubnetIds:
    Description: SubnetIds of existing subnets of the VPC
    Type: List<AWS::EC2::Subnet::Id>
  VpcId:
    Description: VpcId of an existing VPC.
    Type: AWS::EC2::VPC::Id
Resources:
  DatabaseSubnetGroup:
    Properties:
      DBSubnetGroupDescription: RDS subnet group
      SubnetIds: !Ref 'SubnetIds'
    Type: AWS::RDS::DBSubnetGroup
  PostgresRDS:
    DeletionPolicy: Snapshot
    Properties:
      AllocatedStorage: !Ref 'StorageSize'
      DBInstanceClass: !Ref 'DatabaseClass'
      DBSnapshotIdentifier: !If [UseSnapshotCondition, !Ref 'DatabaseSnapshot', !Ref 'AWS::NoValue']
      DBSubnetGroupName: !Ref 'DatabaseSubnetGroup'
      Engine: postgres
      EngineVersion: !Ref 'DatabaseEngineVersion'
      Iops: !If [IopsStorageCondition, !Ref 'StorageIops', !Ref 'AWS::NoValue']
      KmsKeyId: !If [DefaultKmsCondition, !Ref 'AWS::NoValue', !Ref 'KmsKeyId']
      MasterUserPassword: !If [NewDatabaseCondition, !Ref 'DatabasePassword', !Ref 'AWS::NoValue']
      MasterUsername: !If [NewDatabaseCondition, !Ref 'DatabaseUser', !Ref 'AWS::NoValue']
      MonitoringInterval: !If [EnhancedMonitoringCondition, '60', !Ref 'AWS::NoValue']
      MonitoringRoleArn: !If [EnhancedMonitoringCondition, !Sub 'arn:aws:iam::${AWS::AccountId}:role/${EnhancedMonitoringConditionRole}',
        !Ref 'AWS::NoValue']
      Port: '5432'
      PubliclyAccessible: !Ref 'PubliclyAccessible'
      StorageEncrypted: !Ref 'StorageEncrypted'
      StorageType: !Ref 'StorageType'
      VPCSecurityGroups:
      - !If [CreateSecurityGroupCondition, !Ref 'RdsSecurityGroup', !Ref 'SecurityGroup']
    Type: AWS::RDS::DBInstance
  RdsSecurityGroup:
    Condition: CreateSecurityGroupCondition
    Properties:
      GroupDescription: Enable local postgres access
      SecurityGroupIngress:
      - CidrIp: !Ref 'ClientLocation'
        FromPort: '5432'
        IpProtocol: tcp
        ToPort: '5432'
      VpcId: !Ref 'VpcId'
    Type: AWS::EC2::SecurityGroup
